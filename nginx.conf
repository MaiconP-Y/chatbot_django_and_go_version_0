# 1. Configura√ß√£o de Rate Limiting (zona http)
limit_req_zone $binary_remote_addr zone=webhook_limit:10m rate=5r/s;


# üéØ CORRE√á√ÉO FINAL 1: Define o DNS Resolver no escopo HTTP (global).
# Isso garante que ele seja lido antes de qualquer upstream que use 'resolve'.
resolver 127.0.0.11 valid=5s; 


# Upstream para o seu servi√ßo Django
upstream django_app {
    server django-web:8000; 
}

# Upstream para o seu novo Go Gateway (Onde o Webhook Chega)
upstream go_gateway_app {
    # CR√çTICO: shared memory
    zone go_app_state 64k; 
    
    # CR√çTICO: resolu√ß√£o din√¢mica
    server go-gateway:8080 resolve; 
}

server {
    listen 80;
    server_name localhost;

    # ‚ö†Ô∏è REMOVEMOS A LINHA 'resolver 127.0.0.11 valid=5s;' DAQUI

    # 4. Seguran√ßa Adicional - Headers
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    # 3. Novo Localiza√ß√£o para o Webhook (Go Gateway)
    location /webhook {
        limit_req zone=webhook_limit burst=5 nodelay; 
        proxy_pass http://go_gateway_app; 
        
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_redirect off;
    }
    
    # MANTER: 1. Servir Arquivos Est√°ticos (para o Admin Django)
    location /static/ {
        alias /var/www/staticfiles_dist/; 
        expires 30d;
    }
    
    # MANTER: 2. Proxy Reverso para o Django (Tr√°fego Geral)
    location / {
        proxy_pass http://django_app;
        
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_redirect off;
    }
}